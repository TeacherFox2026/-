<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>語音記帳兔兔本</title>
    
    <!-- iOS 專用設定 (讓它在 iPhone 上像 App 一樣) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="兔兔記帳">
    
    <!-- Android/Chrome 主題色 -->
    <meta name="theme-color" content="#FEFDF5">

    <!-- 引入外部資源 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind 設定 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'kawaii-green': '#A8E6CF',
                        'kawaii-green-dark': '#8bdebd',
                        'kawaii-pink': '#FF8B94',
                        'kawaii-pink-dark': '#ff707c',
                        'kawaii-bg': '#FEFDF5',
                        'kawaii-text': '#5D5C61'
                    },
                    fontFamily: {
                        'sans': ['"Zen Maru Gothic"', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 15px rgba(168, 230, 207, 0.4)',
                        'inner-soft': 'inset 0 2px 5px rgba(0,0,0,0.05)'
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #FEFDF5;
            color: #5D5C61;
            font-family: 'Zen Maru Gothic', sans-serif;
            -webkit-tap-highlight-color: transparent;
            /* 防止 iOS 回彈效果，讓它更像 App */
            overscroll-behavior-y: none;
        }

        /* 錄音呼吸燈 */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(255, 139, 148, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 15px rgba(255, 139, 148, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(255, 139, 148, 0); }
        }

        .mic-active {
            animation: pulse-ring 1.5s infinite;
            background-color: #FF8B94 !important;
            color: white !important;
            border-color: #FF8B94 !important;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .slide-in { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 安裝按鈕動畫 */
        .install-pulse { animation: bounce-slight 2s infinite; }
        @keyframes bounce-slight {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden">

    <!-- PWA 安裝提示 (預設隱藏) -->
    <div id="install-prompt" class="hidden fixed top-0 left-0 w-full h-full z-50 bg-black/50 flex items-end justify-center pb-10 fade-in">
        <div class="bg-white w-[90%] max-w-md rounded-2xl p-5 shadow-2xl relative">
            <button onclick="dismissInstall()" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-kawaii-green rounded-xl flex items-center justify-center text-2xl text-white">
                    <i class="fa-solid fa-carrot"></i>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-gray-700">安裝兔兔記帳本</h3>
                    <p class="text-xs text-gray-500">加到主畫面，使用更方便！</p>
                </div>
            </div>
            <button id="install-btn" class="w-full mt-4 bg-kawaii-pink text-white py-3 rounded-xl font-bold shadow-md active:scale-95 transition-transform">
                安裝 App
            </button>
        </div>
    </div>

    <!-- Header -->
    <header class="pt-10 pb-2 px-6 text-center bg-kawaii-bg sticky top-0 z-10">
        <div class="flex justify-between items-center mb-1">
            <div class="w-8"></div> <!-- 佔位 -->
            <h1 class="text-2xl font-bold text-kawaii-text tracking-widest flex items-center justify-center">
                <i class="fa-solid fa-carrot text-kawaii-pink mr-2"></i>語音記帳
            </h1>
            <!-- 設定按鈕 (含安裝觸發) -->
            <button onclick="checkForInstall()" class="w-8 h-8 rounded-full bg-white shadow-sm text-gray-400 flex items-center justify-center active:bg-gray-100">
                <i class="fa-solid fa-download"></i>
            </button>
        </div>
        <p class="text-xs text-gray-400">今天也要好好理財喔！</p>
    </header>

    <!-- 總金額卡片 -->
    <section class="px-5 mt-2 mb-2 shrink-0">
        <div class="bg-kawaii-green rounded-3xl p-6 text-center shadow-soft text-white relative overflow-hidden transition-transform active:scale-[0.98]">
            <div class="absolute top-[-20px] left-[-20px] w-20 h-20 bg-white opacity-20 rounded-full"></div>
            <div class="absolute bottom-[-10px] right-[-10px] w-16 h-16 bg-white opacity-20 rounded-full"></div>
            
            <h2 class="text-sm font-medium opacity-90 mb-1">本月總支出</h2>
            <div class="text-4xl font-bold tracking-wider flex justify-center items-baseline">
                <span class="text-xl mr-1">$</span>
                <span id="monthly-total">0</span>
            </div>
            <div class="mt-2 text-xs opacity-80 bg-white/20 inline-block px-3 py-1 rounded-full">
                <i class="fa-regular fa-calendar mr-1"></i> <span id="current-month-display">--</span>
            </div>
        </div>
    </section>

    <!-- 列表區域 -->
    <main class="flex-1 overflow-y-auto px-5 pb-32 no-scrollbar" id="expense-list-container">
        <div id="empty-state" class="text-center mt-10 opacity-50 hidden">
            <i class="fa-solid fa-basket-shopping text-6xl text-gray-300 mb-4"></i>
            <p>目前沒有紀錄<br>按下麥克風說話吧！<br><span class="text-xs mt-2 block">(例如: 飲料 50元)</span></p>
        </div>
        <ul id="expense-list" class="space-y-3 mt-4 pb-10"></ul>
    </main>

    <!-- 底部控制區 -->
    <footer class="fixed bottom-0 left-0 w-full bg-white rounded-t-[30px] shadow-[0_-5px_30px_rgba(0,0,0,0.08)] p-5 z-20 pb-safe-area">
        <div id="status-text" class="text-center text-xs text-kawaii-pink mb-4 h-4 font-bold transition-all"></div>

        <div class="flex items-center gap-3 mb-2">
            <div class="flex-1 bg-gray-50 rounded-2xl p-1 flex items-center border border-gray-100 shadow-inner-soft transition-all focus-within:border-kawaii-green focus-within:ring-2 focus-within:ring-kawaii-green/20">
                <input type="text" id="item-input" placeholder="品項" class="w-2/3 bg-transparent border-none focus:ring-0 text-sm px-3 py-3 text-gray-600 outline-none">
                <div class="w-px h-6 bg-gray-200"></div>
                <input type="number" id="price-input" placeholder="$" class="w-1/3 bg-transparent border-none focus:ring-0 text-sm px-3 py-3 font-bold text-kawaii-pink placeholder-kawaii-pink/50 outline-none">
            </div>

            <button id="add-btn" class="w-12 h-12 rounded-full bg-gray-100 text-gray-400 hover:bg-kawaii-green hover:text-white transition-all flex items-center justify-center shadow-sm active:scale-90">
                <i class="fa-solid fa-check"></i>
            </button>
        </div>

        <div class="absolute left-1/2 -translate-x-1/2 -top-10">
            <button id="mic-btn" class="w-20 h-20 rounded-full bg-kawaii-green text-white text-3xl shadow-xl shadow-kawaii-green/40 flex items-center justify-center transition-transform active:scale-95 border-[6px] border-white">
                <i class="fa-solid fa-microphone"></i>
            </button>
        </div>
    </footer>

    <!-- CSS Padding for iPhone Home Bar -->
    <style>
        .pb-safe-area { padding-bottom: env(safe-area-inset-bottom, 20px); }
    </style>

    <script>
        // --- 1. PWA & Manifest 自動注入邏輯 ---
        function initPWA() {
            // 建立 App 圖示 (SVG 轉 Base64)
            const iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" fill="#A8E6CF"/><path d="M256 100c-60 0-100 40-100 100v50h200v-50c0-60-40-100-100-100z" fill="#fff"/><circle cx="200" cy="180" r="15" fill="#5D5C61"/><circle cx="312" cy="180" r="15" fill="#5D5C61"/><path d="M256 220l-10-10h20z" fill="#FF8B94"/></svg>`;
            const iconUrl = 'data:image/svg+xml;base64,' + btoa(iconSvg);

            // 建立 Manifest JSON
            const manifest = {
                "name": "語音記帳兔兔本",
                "short_name": "兔兔記帳",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#FEFDF5",
                "theme_color": "#FEFDF5",
                "orientation": "portrait",
                "icons": [{
                    "src": iconUrl,
                    "sizes": "512x512",
                    "type": "image/svg+xml"
                }]
            };

            // 將 Manifest 注入 head
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = 'data:application/manifest+json;charset=utf-8,' + encodeURIComponent(JSON.stringify(manifest));
            document.head.appendChild(link);

            // 注入 Apple Touch Icon
            const appleIcon = document.createElement('link');
            appleIcon.rel = 'apple-touch-icon';
            appleIcon.href = iconUrl;
            document.head.appendChild(appleIcon);
        }

        initPWA();

        // --- 2. 處理安裝提示 ---
        let deferredPrompt;
        const installPrompt = document.getElementById('install-prompt');
        const installBtn = document.getElementById('install-btn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // 可以在這裡自動顯示提示，或者等待使用者點擊按鈕
            // 目前策略：顯示右上角的下載按鈕會有反應
        });

        function checkForInstall() {
            if (deferredPrompt) {
                installPrompt.classList.remove('hidden');
            } else {
                // 如果是 iOS 或已經安裝，提示使用者
                alert('如果您使用 iPhone (Safari)：\n請點擊底部的「分享」按鈕，\n然後選擇「加入主畫面」。\n\n如果您已安裝，請直接開啟 App！');
            }
        }

        function dismissInstall() {
            installPrompt.classList.add('hidden');
        }

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                installPrompt.classList.add('hidden');
            }
        });

        // --- 3. 核心功能邏輯 (與之前相同但微調) ---
        const micBtn = document.getElementById('mic-btn');
        const addBtn = document.getElementById('add-btn');
        const itemInput = document.getElementById('item-input');
        const priceInput = document.getElementById('price-input');
        const expenseList = document.getElementById('expense-list');
        const monthlyTotalEl = document.getElementById('monthly-total');
        const currentMonthDisplay = document.getElementById('current-month-display');
        const statusText = document.getElementById('status-text');
        const emptyState = document.getElementById('empty-state');

        let expenses = [];
        let isListening = false;
        let editingId = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            updateDateDisplay();
            renderList();
        });

        function updateDateDisplay() {
            const now = new Date();
            currentMonthDisplay.textContent = `${now.getFullYear()}年 ${now.getMonth() + 1}月`;
        }

        function loadData() {
            const stored = localStorage.getItem('kawaii_expenses');
            if (stored) expenses = JSON.parse(stored);
        }

        function saveData() {
            localStorage.setItem('kawaii_expenses', JSON.stringify(expenses));
            renderList();
        }

        function renderList() {
            expenseList.innerHTML = '';
            const now = new Date();
            let total = 0;
            const sortedExpenses = [...expenses].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (sortedExpenses.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                sortedExpenses.forEach(exp => {
                    const date = new Date(exp.timestamp);
                    if (date.getFullYear() === now.getFullYear() && date.getMonth() === now.getMonth()) {
                        total += parseInt(exp.price);
                    }
                    const li = document.createElement('li');
                    li.className = 'bg-white rounded-2xl p-4 shadow-sm flex items-center justify-between slide-in border border-gray-50';
                    li.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="bg-orange-100 w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center text-orange-400">
                                <i class="fa-solid fa-tag"></i>
                            </div>
                            <div class="truncate">
                                <h3 class="font-bold text-gray-700 text-sm truncate">${exp.item}</h3>
                                <p class="text-xs text-gray-400">${formatDate(date)}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 flex-shrink-0">
                            <span class="text-kawaii-pink font-bold text-lg">$${exp.price}</span>
                            <div class="flex gap-1 ml-1">
                                <button onclick="editExpense(${exp.id})" class="w-8 h-8 rounded-full bg-blue-50 text-blue-400 hover:bg-blue-100 transition-colors text-xs"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="deleteExpense(${exp.id})" class="w-8 h-8 rounded-full bg-red-50 text-red-400 hover:bg-red-100 transition-colors text-xs"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                    expenseList.appendChild(li);
                });
            }
            monthlyTotalEl.textContent = total; // 簡單更新，避免動畫數字跳動問題
        }

        // --- 語音辨識 (Web Speech API) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'zh-TW';
            recognition.continuous = false;
            recognition.interimResults = false;

            micBtn.addEventListener('click', () => {
                if (isListening) recognition.stop();
                else recognition.start();
            });

            recognition.onstart = () => {
                isListening = true;
                micBtn.classList.add('mic-active');
                micBtn.innerHTML = '<i class="fa-solid fa-stop"></i>';
                statusText.textContent = "請說 (例如: 午餐 100)";
            };

            recognition.onend = () => {
                isListening = false;
                micBtn.classList.remove('mic-active');
                micBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
                if(!statusText.textContent.includes("已新增")) statusText.textContent = "";
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                statusText.textContent = `聽到: "${transcript}"...`;
                parseAndFill(transcript);
            };

            recognition.onerror = () => {
                statusText.textContent = "聽不清楚，請再試一次";
                isListening = false;
                micBtn.classList.remove('mic-active');
            };
        } else {
            micBtn.style.display = 'none';
            statusText.textContent = "此裝置不支援語音";
        }

        function parseAndFill(text) {
            const priceMatch = text.match(/\d+/);
            if (priceMatch) {
                const price = priceMatch[0];
                let item = text.replace(price, '').replace(/元|塊|錢/g, '').trim();
                if (!item) item = "未命名項目";
                itemInput.value = item;
                priceInput.value = price;
                addExpense();
                statusText.textContent = `已新增: ${item} $${price}`;
                setTimeout(() => { statusText.textContent = ""; }, 2500);
            } else {
                statusText.textContent = "無法辨識金額";
            }
        }

        addBtn.addEventListener('click', addExpense);

        function addExpense() {
            const item = itemInput.value.trim();
            const price = priceInput.value.trim();
            if (!item || !price) return;

            if (editingId) {
                const index = expenses.findIndex(e => e.id === editingId);
                if (index !== -1) {
                    expenses[index].item = item;
                    expenses[index].price = parseInt(price);
                }
                editingId = null;
                addBtn.innerHTML = '<i class="fa-solid fa-check"></i>';
                addBtn.className = "w-12 h-12 rounded-full bg-gray-100 text-gray-400 hover:bg-kawaii-green hover:text-white transition-all flex items-center justify-center shadow-sm active:scale-90";
            } else {
                expenses.push({
                    id: Date.now(),
                    item,
                    price: parseInt(price),
                    timestamp: new Date().toISOString()
                });
            }
            itemInput.value = '';
            priceInput.value = '';
            saveData();
        }

        window.deleteExpense = function(id) {
            if(confirm('刪除此筆紀錄？')) {
                expenses = expenses.filter(e => e.id !== id);
                saveData();
            }
        };

        window.editExpense = function(id) {
            const exp = expenses.find(e => e.id === id);
            if (exp) {
                itemInput.value = exp.item;
                priceInput.value = exp.price;
                editingId = id;
                itemInput.focus();
                addBtn.innerHTML = '<i class="fa-solid fa-rotate"></i>';
                addBtn.className = "w-12 h-12 rounded-full bg-kawaii-pink text-white flex items-center justify-center shadow-md active:scale-90 transition-transform";
                statusText.textContent = "編輯模式";
            }
        };

        function formatDate(date) {
            return `${date.getMonth() + 1}/${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }
    </script>
</body>
</html>